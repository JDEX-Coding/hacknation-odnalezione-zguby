version: '3.8'

services:
  qdrant-service:
    container_name: odnalezione-qdrant-service
    build:
      context: ./qdrant-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
      - QDRANT_ADDR=odnalezione-qdrant-db:6334
      - COLLECTION_NAME=lost_items
    depends_on:
      - qdrant-db
      - rabbitmq
    restart: unless-stopped
    networks:
      - odnalezione-network

  qdrant-db:
    container_name: odnalezione-qdrant-db
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - odnalezione-network

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: odnalezione-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq-init.sh:/docker-entrypoint-initdb.d/init.sh:ro
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - odnalezione-network

  # MinIO - S3-compatible Object Storage for Images
  minio:
    image: minio/minio:latest
    container_name: odnalezione-minio
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console UI
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - odnalezione-network

  # MinIO Client - Initialize buckets
  minio-init:
    image: minio/mc:latest
    container_name: odnalezione-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin123;
      mc mb myminio/lost-items-images --ignore-existing;
      mc anonymous set download myminio/lost-items-images;
      echo 'MinIO bucket created successfully';
      "
    networks:
      - odnalezione-network

volumes:
  qdrant-service:
    driver: local
  qdrant-db:
    driver: local
  rabbitmq_data:
    driver: local
  qdrant_data:
    driver: local
  minio_data:
    driver: local

networks:
  odnalezione-network:
    driver: bridge
