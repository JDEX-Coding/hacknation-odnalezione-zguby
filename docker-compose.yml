version: "3.9"

services:
    clip-service:
        container_name: odnalezione-clip-service
        build:
            context: ./clip-service
            dockerfile: Dockerfile
        environment:
            - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin123
            - MINIO_BUCKET_NAME=lost-items-images
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
        volumes:
            - clip_cache:/app/.cache/huggingface

    qdrant-service:
        container_name: odnalezione-qdrant-service
        build:
            context: ./qdrant-service
            dockerfile: Dockerfile
        ports:
            - "8080:8080"
        environment:
            - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
            - QDRANT_ADDR=odnalezione-qdrant-db:6334
            - COLLECTION_NAME=lost_items
        depends_on:
            - qdrant-db
            - rabbitmq
        restart: unless-stopped
        networks:
            - odnalezione-network
        qdrant-service:
            container_name: odnalezione-qdrant-service
            build:
                context: ./qdrant-service
                dockerfile: Dockerfile
            environment:
                - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
                - QDRANT_ADDR=odnalezione-qdrant-db:6334
                - COLLECTION_NAME=lost_items
            depends_on:
                - qdrant-db
                - rabbitmq
            restart: unless-stopped
            networks:
                - odnalezione-network

        qdrant-db:
            container_name: odnalezione-qdrant-db
            image: qdrant/qdrant:latest
            ports:
                - "6333:6333"
            volumes:
                - ./qdrant_storage:/qdrant/storage
            environment:
                - QDRANT__SERVICE__HTTP_PORT=6333
                - QDRANT__SERVICE__GRPC_PORT=6334
            restart: unless-stopped
            networks:
                - odnalezione-network

        rabbitmq:
            image: rabbitmq:3.12-management-alpine
            container_name: odnalezione-rabbitmq
            ports:
                - "5672:5672"
                - "15672:15672" # Management UI
            environment:
                RABBITMQ_DEFAULT_USER: admin
                RABBITMQ_DEFAULT_PASS: admin123
            volumes:
                - rabbitmq_data:/var/lib/rabbitmq
                - ./rabbitmq-init.sh:/docker-entrypoint-initdb.d/init.sh:ro
            healthcheck:
                test: rabbitmq-diagnostics -q ping
                interval: 10s
                timeout: 5s
                retries: 5
            networks:
                - odnalezione-network

        rabbitmq-init:
            image: rabbitmq:3.12-management-alpine
            depends_on:
                rabbitmq:
                    condition: service_healthy
            volumes:
                - ./rabbitmq-init.sh:/rabbitmq-init.sh:ro
            entrypoint: /bin/sh -c '. /rabbitmq-init.sh'
            environment:
                RABBITMQ_HOST: rabbitmq
                RABBITMQ_USER: admin
                RABBITMQ_PASS: admin123
            networks:
                - odnalezione-network

        minio:
            image: minio/minio:latest
            ports:
                - "9000:9000"
                - "9001:9001"
            environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin123
            command: server /data --console-address ":9001"
            volumes:
                - minio_data:/data
            healthcheck:
                test:
                    [
                        "CMD",
                        "curl",
                        "-f",
                        "http://localhost:9000/minio/health/live",
                    ]
                interval: 10s
                timeout: 5s
                retries: 5
            networks:
                - odnalezione-network

        minio-init:
            image: minio/mc:latest
            depends_on:
                minio:
                    condition: service_healthy
            entrypoint: >
                /bin/sh -c "
                mc alias set myminio http://minio:9000 minioadmin minioadmin123;
                mc mb myminio/lost-items-images --ignore-existing;
                mc anonymous set download myminio/lost-items-images;
                echo 'MinIO bucket created successfully';
                "
            networks:
                - odnalezione-network

        postgres:
            image: postgres:15-alpine
            container_name: odnalezione-postgres
            ports:
                - "5432:5432"
            environment:
                POSTGRES_USER: admin
                POSTGRES_PASSWORD: admin123
                POSTGRES_DB: odnalezione_db
            volumes:
                - postgres_data:/var/lib/postgresql/data
            healthcheck:
                test: ["CMD-SHELL", "pg_isready -U admin -d odnalezione_db"]
                interval: 10s
                timeout: 5s
                retries: 5
            networks:
                - odnalezione-network

        a-gateway:
            build:
                context: ./service-a-gateway
                dockerfile: Dockerfile
            ports:
                - "8080:8080"
            environment:
                - GATEWAY_PORT=8080
                - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
                - MINIO_ENDPOINT=minio:9000
                - MINIO_PUBLIC_ENDPOINT=localhost:9000
                - MINIO_ACCESS_KEY=minioadmin
                - MINIO_SECRET_KEY=minioadmin123
                - MINIO_USE_SSL=false
                - VISION_API_KEY=${VISION_API_KEY}
                - DB_HOST=postgres
                - DB_PORT=5432
                - DB_USER=admin
                - DB_PASSWORD=admin123
                - DB_NAME=odnalezione_db
                - DB_SSL_MODE=disable
            depends_on:
                rabbitmq:
                    condition: service_healthy
                minio:
                    condition: service_healthy
                postgres:
                    condition: service_healthy
            networks:
                - odnalezione-network

volumes:
    qdrant-service:
        driver: local
    qdrant-db:
        driver: local
    rabbitmq_data:
        driver: local
    qdrant_data:
        driver: local
    minio_data:
        driver: local
    postgres_data:
        driver: local
    clip_cache:
        driver: local

networks:
    odnalezione-network:
        driver: bridge
