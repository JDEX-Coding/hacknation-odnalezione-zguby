services:
    rabbitmq:
        image: rabbitmq:3.12-management-alpine
        ports:
            - "5672:5672"
            - "15672:15672"
        environment:
            RABBITMQ_DEFAULT_USER: admin
            RABBITMQ_DEFAULT_PASS: admin123
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
            - ./rabbitmq-init.sh:/rabbitmq-init.sh:ro
        healthcheck:
            test: rabbitmq-diagnostics -q ping
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - odnalezione-network

    rabbitmq-init:
        image: rabbitmq:3.12-management-alpine
        depends_on:
            rabbitmq:
                condition: service_healthy
        volumes:
            - ./rabbitmq-init.sh:/rabbitmq-init.sh:ro
        entrypoint: /bin/sh -c '. /rabbitmq-init.sh'
        environment:
            RABBITMQ_HOST: rabbitmq
            RABBITMQ_USER: admin
            RABBITMQ_PASS: admin123
        networks:
            - odnalezione-network

    minio:
        image: minio/minio:latest
        ports:
            - "9000:9000"
            - "9001:9001"
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin123
        command: server /data --console-address ":9001"
        volumes:
            - minio_data:/data
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - odnalezione-network

    minio-init:
        image: minio/mc:latest
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 minioadmin minioadmin123;
            mc mb myminio/lost-items-images --ignore-existing;
            mc anonymous set download myminio/lost-items-images;
            echo 'MinIO bucket created successfully';
            "
        networks:
            - odnalezione-network

    a-gateway:
        build:
            context: ./service-a-gateway
            dockerfile: Dockerfile
        ports:
            - "8080:8080"
        environment:
            - GATEWAY_PORT=8080
            - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin123
            - MINIO_USE_SSL=false
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        networks:
            - odnalezione-network

volumes:
    rabbitmq_data:
        driver: local
    minio_data:
        driver: local

networks:
    odnalezione-network:
        driver: bridge
