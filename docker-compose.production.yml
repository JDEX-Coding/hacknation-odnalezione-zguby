version: "3.9"

services:
    # ========================================
    # GŁÓWNY GATEWAY - Dostępny publicznie
    # ========================================
    a-gateway:
        container_name: odnalezione-gateway
        build:
            context: ./service-a-gateway
            dockerfile: Dockerfile
        environment:
            - GATEWAY_PORT=8080
            - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_PUBLIC_ENDPOINT=https://minio.${DOMAIN}
            - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
            - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
            - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
            - MINIO_USE_SSL=false
            - VISION_API_KEY=${VISION_API_KEY}
            - VISION_API_ENDPOINT=${VISION_API_ENDPOINT:-https://api.openai.com/v1}
            - VISION_MODEL=${VISION_MODEL:-gpt-4o}
            - CLIP_SERVICE_URL=${CLIP_SERVICE_URL:-http://clip-service:8000}
            - QDRANT_SERVICE_URL=${QDRANT_SERVICE_URL:-http://qdrant-service:8081}
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_USER=${POSTGRES_USER}
            - DB_PASSWORD=${POSTGRES_PASSWORD}
            - DB_NAME=${POSTGRES_DB}
            - DB_SSL_MODE=disable
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=dokploy-network"
            - "traefik.http.routers.odnalezione-gateway.rule=Host(`visionlink.${DOMAIN}`)"
            - "traefik.http.routers.odnalezione-gateway.entrypoints=websecure"
            - "traefik.http.routers.odnalezione-gateway.tls=true"
            - "traefik.http.routers.odnalezione-gateway.tls.certresolver=letsencrypt"
            - "traefik.http.services.odnalezione-gateway-srv.loadbalancer.server.port=8080"
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
            postgres:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
            - dokploy-network

    # ========================================
    # CLIP SERVICE - Przetwarzanie AI
    # ========================================
    clip-service:
        container_name: odnalezione-clip-service
        build:
            context: ./clip-service
            dockerfile: Dockerfile
        environment:
            - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
            - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
            - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
        volumes:
            - clip_cache:/app/.cache/huggingface
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G

    # ========================================
    # QDRANT SERVICE - Integracja z Qdrant DB
    # ========================================
    qdrant-service:
        container_name: odnalezione-qdrant-service
        build:
            context: ./qdrant-service
            dockerfile: Dockerfile
        environment:
            - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
            - QDRANT_ADDR=qdrant-db:6334
            - COLLECTION_NAME=${QDRANT_COLLECTION_NAME}
        depends_on:
            qdrant-db:
                condition: service_started
            rabbitmq:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
            - dokploy-network

    # ========================================
    # QDRANT DATABASE - Baza wektorowa
    # ========================================
    qdrant-db:
        container_name: odnalezione-qdrant-db
        image: qdrant/qdrant:latest
        volumes:
            - qdrant_data:/qdrant/storage
        environment:
            - QDRANT__SERVICE__HTTP_PORT=6333
            - QDRANT__SERVICE__GRPC_PORT=6334
        restart: unless-stopped
        networks:
            - odnalezione-network
            - dokploy-network
        deploy:
            resources:
                limits:
                    memory: 1G

    # ========================================
    # RABBITMQ - Message Broker
    # ========================================
    rabbitmq:
        image: rabbitmq:3.12-management-alpine
        container_name: odnalezione-rabbitmq
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
            RABBITMQ_DEFAULT_VHOST: /
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
            - ./rabbitmq-init.sh:/docker-entrypoint-initdb.d/init.sh:ro
        healthcheck:
            test: rabbitmq-diagnostics -q ping
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - odnalezione-network
            - dokploy-network

    # ========================================
    # RABBITMQ INIT - Inicjalizacja kolejek
    # ========================================
    rabbitmq-init:
        image: rabbitmq:3.12-management-alpine
        depends_on:
            rabbitmq:
                condition: service_healthy
        volumes:
            - ./rabbitmq-init.sh:/rabbitmq-init.sh:ro
        entrypoint: /bin/sh -c '. /rabbitmq-init.sh'
        environment:
            RABBITMQ_HOST: rabbitmq
            RABBITMQ_USER: ${RABBITMQ_USER}
            RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
        networks:
            - odnalezione-network

    # ========================================
    # MINIO - Object Storage
    # ========================================
    minio:
        image: minio/minio:latest
        container_name: odnalezione-minio
        environment:
            MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
            MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
            MINIO_SERVER_URL: https://minio.${DOMAIN}
            MINIO_BROWSER_REDIRECT_URL: https://minio-console.${DOMAIN}
            MINIO_API_CORS_ALLOW_ORIGIN: https://visionlink.${DOMAIN},https://${DOMAIN}
        command: server /data --console-address ":9001"
        volumes:
            - minio_data:/data
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=dokploy-network"
            - "traefik.http.routers.odnalezione-minio-api.rule=Host(`minio.${DOMAIN}`)"
            - "traefik.http.routers.odnalezione-minio-api.entrypoints=websecure"
            - "traefik.http.routers.odnalezione-minio-api.tls=true"
            - "traefik.http.routers.odnalezione-minio-api.tls.certresolver=letsencrypt"
            - "traefik.http.services.odnalezione-minio-api-srv.loadbalancer.server.port=9000"

            - "traefik.http.routers.odnalezione-minio-console.rule=Host(`minio-console.${DOMAIN}`)"
            - "traefik.http.routers.odnalezione-minio-console.entrypoints=websecure"
            - "traefik.http.routers.odnalezione-minio-console.tls=true"
            - "traefik.http.routers.odnalezione-minio-console.tls.certresolver=letsencrypt"
            - "traefik.http.services.odnalezione-minio-console-srv.loadbalancer.server.port=9001"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - odnalezione-network
            - dokploy-network

    # ========================================
    # MINIO INIT - Inicjalizacja bucketów
    # ========================================
    minio-init:
        image: minio/mc:latest
        container_name: odnalezione-minio-init
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY};
            mc mb myminio/${MINIO_BUCKET_NAME} --ignore-existing;
            mc anonymous set public myminio/${MINIO_BUCKET_NAME};
            echo 'MinIO bucket created and set to public read';
            "
        networks:
            - odnalezione-network

    # ========================================
    # POSTGRESQL - Relacyjna baza danych
    # ========================================
    postgres:
        image: postgres:15-alpine
        container_name: odnalezione-postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - odnalezione-network
        deploy:
            resources:
                limits:
                    memory: 512M

# ========================================
# VOLUMES
# ========================================
volumes:
    rabbitmq_data:
        driver: local
    qdrant_data:
        driver: local
    minio_data:
        driver: local
    postgres_data:
        driver: local
    clip_cache:
        driver: local

# ========================================
# NETWORKS
# ========================================
networks:
    odnalezione-network:
        driver: bridge
    dokploy-network:
        external: true
