version: "3.9"

services:
    # ========================================
    # GŁÓWNY GATEWAY - Dostępny publicznie
    # ========================================
    a-gateway:
        container_name: odnalezione-gateway
        build:
            context: ./service-a-gateway
            dockerfile: Dockerfile
        environment:
            - GATEWAY_PORT=8080
            - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_PUBLIC_ENDPOINT=${MINIO_PUBLIC_ENDPOINT}
            - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
            - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
            - MINIO_USE_SSL=false
            - VISION_API_KEY=${VISION_API_KEY}
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_USER=${POSTGRES_USER}
            - DB_PASSWORD=${POSTGRES_PASSWORD}
            - DB_NAME=${POSTGRES_DB}
            - DB_SSL_MODE=disable
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.gateway.rule=Host(`${DOMAIN}`)"
            - "traefik.http.routers.gateway.entrypoints=websecure"
            - "traefik.http.routers.gateway.tls=true"
            - "traefik.http.routers.gateway.tls.certresolver=letsencrypt"
            - "traefik.http.services.gateway.loadbalancer.server.port=8080"
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
            postgres:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
            - traefik-public

    # ========================================
    # CLIP SERVICE - Przetwarzanie AI
    # ========================================
    clip-service:
        container_name: odnalezione-clip-service
        build:
            context: ./clip-service
            dockerfile: Dockerfile
        environment:
            - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
            - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
            - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
        depends_on:
            rabbitmq:
                condition: service_healthy
            minio:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
        volumes:
            - clip_cache:/app/.cache/huggingface
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G

    # ========================================
    # QDRANT SERVICE - Integracja z Qdrant DB
    # ========================================
    qdrant-service:
        container_name: odnalezione-qdrant-service
        build:
            context: ./qdrant-service
            dockerfile: Dockerfile
        environment:
            - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
            - QDRANT_ADDR=qdrant-db:6334
            - COLLECTION_NAME=${QDRANT_COLLECTION_NAME}
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.qdrant-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/api/qdrant`)"
            - "traefik.http.routers.qdrant-service.entrypoints=websecure"
            - "traefik.http.routers.qdrant-service.tls=true"
            - "traefik.http.routers.qdrant-service.tls.certresolver=letsencrypt"
            - "traefik.http.services.qdrant-service.loadbalancer.server.port=8080"
            - "traefik.http.middlewares.qdrant-strip.stripprefix.prefixes=/api/qdrant"
            - "traefik.http.routers.qdrant-service.middlewares=qdrant-strip"
        depends_on:
            qdrant-db:
                condition: service_started
            rabbitmq:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - odnalezione-network
            - traefik-public

    # ========================================
    # QDRANT DATABASE - Baza wektorowa
    # ========================================
    qdrant-db:
        container_name: odnalezione-qdrant-db
        image: qdrant/qdrant:latest
        volumes:
            - qdrant_data:/qdrant/storage
        environment:
            - QDRANT__SERVICE__HTTP_PORT=6333
            - QDRANT__SERVICE__GRPC_PORT=6334
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.qdrant.rule=Host(`qdrant.${DOMAIN}`)"
            - "traefik.http.routers.qdrant.entrypoints=websecure"
            - "traefik.http.routers.qdrant.tls=true"
            - "traefik.http.routers.qdrant.tls.certresolver=letsencrypt"
            - "traefik.http.services.qdrant.loadbalancer.server.port=6333"
            # Opcjonalna autoryzacja Basic Auth
            - "traefik.http.routers.qdrant.middlewares=qdrant-auth"
            - "traefik.http.middlewares.qdrant-auth.basicauth.users=${QDRANT_BASIC_AUTH}"
        restart: unless-stopped
        networks:
            - odnalezione-network
            - traefik-public
        deploy:
            resources:
                limits:
                    memory: 1G

    # ========================================
    # RABBITMQ - Message Broker
    # ========================================
    rabbitmq:
        image: rabbitmq:3.12-management-alpine
        container_name: odnalezione-rabbitmq
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
            RABBITMQ_DEFAULT_VHOST: /
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
            - ./rabbitmq-init.sh:/docker-entrypoint-initdb.d/init.sh:ro
        labels:
            - "traefik.enable=true"
            # Management UI
            - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.${DOMAIN}`)"
            - "traefik.http.routers.rabbitmq.entrypoints=websecure"
            - "traefik.http.routers.rabbitmq.tls=true"
            - "traefik.http.routers.rabbitmq.tls.certresolver=letsencrypt"
            - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"
            # Basic Auth protection
            - "traefik.http.routers.rabbitmq.middlewares=rabbitmq-auth"
            - "traefik.http.middlewares.rabbitmq-auth.basicauth.users=${RABBITMQ_BASIC_AUTH}"
        healthcheck:
            test: rabbitmq-diagnostics -q ping
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - odnalezione-network
            - traefik-public

    # ========================================
    # RABBITMQ INIT - Inicjalizacja kolejek
    # ========================================
    rabbitmq-init:
        image: rabbitmq:3.12-management-alpine
        depends_on:
            rabbitmq:
                condition: service_healthy
        volumes:
            - ./rabbitmq-init.sh:/rabbitmq-init.sh:ro
        entrypoint: /bin/sh -c '. /rabbitmq-init.sh'
        environment:
            RABBITMQ_HOST: rabbitmq
            RABBITMQ_USER: ${RABBITMQ_USER}
            RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
        networks:
            - odnalezione-network

    # ========================================
    # MINIO - Object Storage
    # ========================================
    minio:
        image: minio/minio:latest
        container_name: odnalezione-minio
        environment:
            MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
            MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
            MINIO_BROWSER_REDIRECT_URL: https://minio-console.${DOMAIN}
        command: server /data --console-address ":9001"
        volumes:
            - minio_data:/data
        labels:
            - "traefik.enable=true"
            # API endpoint
            - "traefik.http.routers.minio-api.rule=Host(`minio.${DOMAIN}`)"
            - "traefik.http.routers.minio-api.entrypoints=websecure"
            - "traefik.http.routers.minio-api.tls=true"
            - "traefik.http.routers.minio-api.tls.certresolver=letsencrypt"
            - "traefik.http.routers.minio-api.service=minio-api"
            - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
            # Console endpoint
            - "traefik.http.routers.minio-console.rule=Host(`minio-console.${DOMAIN}`)"
            - "traefik.http.routers.minio-console.entrypoints=websecure"
            - "traefik.http.routers.minio-console.tls=true"
            - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
            - "traefik.http.routers.minio-console.service=minio-console"
            - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
            # Basic Auth dla console (opcjonalne)
            - "traefik.http.routers.minio-console.middlewares=minio-auth"
            - "traefik.http.middlewares.minio-auth.basicauth.users=${MINIO_BASIC_AUTH}"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - odnalezione-network
            - traefik-public

    # ========================================
    # MINIO INIT - Inicjalizacja bucketów
    # ========================================
    minio-init:
        image: minio/mc:latest
        container_name: odnalezione-minio-init
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY};
            mc mb myminio/${MINIO_BUCKET_NAME} --ignore-existing;
            mc anonymous set download myminio/${MINIO_BUCKET_NAME};
            echo 'MinIO bucket created successfully';
            "
        networks:
            - odnalezione-network

    # ========================================
    # POSTGRESQL - Relacyjna baza danych
    # ========================================
    postgres:
        image: postgres:15-alpine
        container_name: odnalezione-postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - odnalezione-network
        deploy:
            resources:
                limits:
                    memory: 512M

# ========================================
# VOLUMES
# ========================================
volumes:
    rabbitmq_data:
        driver: local
    qdrant_data:
        driver: local
    minio_data:
        driver: local
    postgres_data:
        driver: local
    clip_cache:
        driver: local

# ========================================
# NETWORKS
# ========================================
networks:
    odnalezione-network:
        driver: bridge
    traefik-public:
        external: true
