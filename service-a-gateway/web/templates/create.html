{{define "content"}}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Dodaj Nową Zgubę</h1>
        <p class="text-gray-600">
            Wypełnij formularz poniżej. AI pomoże Ci automatycznie opisać
            przedmiot na podstawie zdjęcia.
        </p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <form
            id="create-form"
            hx-post="/create"
            hx-encoding="multipart/form-data"
            hx-indicator="#submit-indicator"
            class="space-y-6"
        >
            <!-- Image Upload Section -->
            <div
                id="upload-zone"
                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer"
                onclick="document.getElementById('image').click()"
            >
                <div class="space-y-4">
                    <div
                        class="mx-auto w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center"
                    >
                        <svg
                            class="w-12 h-12 text-blue-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                            ></path>
                        </svg>
                    </div>

                    <div>
                        <span
                            class="text-blue-600 hover:text-blue-700 font-medium"
                            >Kliknij aby wybrać zdjęcie</span
                        >
                        <span class="text-gray-600">
                            lub przeciągnij i upuść</span
                        >
                        <input
                            type="file"
                            id="image"
                            name="image"
                            accept="image/*"
                            required
                            class="hidden"
                            onchange="handleImageUpload(this)"
                        />
                        <p class="text-sm text-gray-500 mt-2">
                            PNG, JPG, GIF do 10MB
                        </p>
                    </div>

                    <!-- Image Preview -->
                    <div
                        id="image-preview"
                        class="hidden mt-4"
                        onclick="event.stopPropagation()"
                    >
                        <img
                            id="preview-img"
                            class="mx-auto max-h-64 rounded-lg shadow-lg"
                            alt="Podgląd"
                        />
                        <button
                            type="button"
                            onclick="clearImage(); event.stopPropagation();"
                            class="mt-3 text-sm text-red-600 hover:text-red-800"
                        >
                            Usuń zdjęcie
                        </button>
                    </div>

                    <!-- AI Analysis Button -->
                    <div
                        id="analyze-section"
                        class="hidden"
                        onclick="event.stopPropagation()"
                    >
                        <button
                            type="button"
                            onclick="analyzeImage(); event.stopPropagation();"
                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                                ></path>
                            </svg>
                            <span id="analyze-button-text"
                                >Opisz zdjęcie za pomocą AI</span
                            >
                            <span
                                id="analyze-indicator"
                                class="ml-2"
                                style="display: none"
                            >
                                <div class="spinner"></div>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Suggestions Container -->
            <div id="ai-suggestions"></div>

            <!-- Title -->
            <div>
                <label
                    for="title"
                    class="block text-sm font-semibold text-gray-700 mb-2"
                >
                    Tytuł zgłoszenia <span class="text-red-500">*</span>
                </label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    required
                    placeholder="np. Znaleziony portfel"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
                <p class="mt-1 text-sm text-gray-500">Krótki, opisowy tytuł</p>
            </div>

            <!-- Description -->
            <div>
                <label
                    for="description"
                    class="block text-sm font-semibold text-gray-700 mb-2"
                >
                    Opis przedmiotu <span class="text-red-500">*</span>
                </label>
                <textarea
                    id="description"
                    name="description"
                    rows="4"
                    required
                    placeholder="Szczegółowy opis znalezionego przedmiotu..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                ></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Im więcej szczegółów, tym łatwiej właściciel odnajdzie swój
                    przedmiot
                </p>
            </div>

            <!-- Category -->
            <div>
                <label
                    for="category"
                    class="block text-sm font-semibold text-gray-700 mb-2"
                >
                    Kategoria <span class="text-red-500">*</span>
                </label>
                <select
                    id="category"
                    name="category"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                >
                    <option value="">Wybierz kategorię</option>
                    {{range .Categories}}
                    <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
            </div>

            <!-- Location Section -->
            <div
                class="space-y-6 bg-gray-50 p-6 rounded-lg border border-gray-200"
            >
                <h3 class="text-lg font-semibold text-gray-900">
                    Miejsce i data znalezienia
                </h3>

                <!-- Found Location -->
                <div>
                    <label
                        for="location"
                        class="block text-sm font-semibold text-gray-700 mb-2"
                    >
                        Miejsce znalezienia <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="location"
                        name="location"
                        required
                        placeholder="np. Rynek Główny, Kraków"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    />
                    <p class="mt-1 text-sm text-gray-500">
                        Podaj dokładną lokalizację
                    </p>
                </div>

                <!-- Found Date -->
                <div>
                    <label
                        for="found_date"
                        class="block text-sm font-semibold text-gray-700 mb-2"
                    >
                        Data znalezienia <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="date"
                        id="found_date"
                        name="found_date"
                        required
                        max="{{.Today}}"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    />
                </div>

                <!-- Reporting Date -->
                <div>
                    <label
                        for="reporting_date"
                        class="block text-sm font-semibold text-gray-700 mb-2"
                    >
                        Data zgłoszenia <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="date"
                        id="reporting_date"
                        name="reporting_date"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-gray-100"
                        readonly
                    />
                </div>

                <!-- Reporting Location -->
                <div>
                    <label
                        for="reporting_location"
                        class="block text-sm font-semibold text-gray-700 mb-2"
                    >
                        Miejsce zgłoszenia
                    </label>
                    <input
                        type="text"
                        id="reporting_location"
                        name="reporting_location"
                        value="Bydgoskie Biuro Rzeczy Znalezionych, ul. Jezuicka 6a/2a"
                        placeholder="np. Komisariat Policji nr 1"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    />
                </div>
            </div>

            <!-- Contact Info -->
            <div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label
                            for="contact_email"
                            class="block text-sm font-semibold text-gray-700 mb-2"
                        >
                            Email
                        </label>
                        <input
                            type="email"
                            id="contact_email"
                            name="contact_email"
                            value="znalezione@um.bydgoszcz.pl"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        />
                    </div>
                    <div>
                        <label
                            for="contact_phone"
                            class="block text-sm font-semibold text-gray-700 mb-2"
                        >
                            Telefon
                        </label>
                        <input
                            type="text"
                            id="contact_phone"
                            name="contact_phone"
                            value="(52) 58 58 087"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        />
                    </div>
                </div>
                <p class="mt-1 text-sm text-gray-500">
                    Dane kontaktowe do biura
                </p>
            </div>

            <!-- Hidden Image URL (for Service B) -->
            <input type="hidden" id="imageUrl" name="imageUrl" value="" />

            <!-- Submit Button -->
            <div
                class="flex items-center justify-between pt-6 border-t border-gray-200"
            >
                <a
                    href="/"
                    class="text-gray-600 hover:text-gray-900 font-medium"
                >
                    ← Anuluj
                </a>

                <button
                    type="submit"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold inline-flex items-center"
                >
                    <svg
                        class="w-5 h-5 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"
                        ></path>
                    </svg>
                    <span>Dodaj Zgubę</span>
                    <span id="submit-indicator" class="htmx-indicator ml-2">
                        <div class="spinner"></div>
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Set today's date
    const today = new Date().toISOString().split("T")[0];

    // Set max date for found_date
    const foundDateInput = document.getElementById("found_date");
    foundDateInput.max = today;
    foundDateInput.value = today; // Auto-fill found date

    // Auto-fill reporting date
    const reportingDateInput = document.getElementById("reporting_date");
    reportingDateInput.value = today;

    // Handle image upload preview
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert("Plik jest za duży. Maksymalny rozmiar to 10MB.");
                input.value = "";
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("preview-img").src = e.target.result;
                document
                    .getElementById("image-preview")
                    .classList.remove("hidden");
                document
                    .getElementById("analyze-section")
                    .classList.remove("hidden");
            };
            reader.readAsDataURL(file);
        }
    }

    // Clear image
    function clearImage() {
        document.getElementById("image").value = "";
        document.getElementById("image-preview").classList.add("hidden");
        document.getElementById("analyze-section").classList.add("hidden");
        document.getElementById("ai-suggestions").innerHTML = "";
    }

    // Analyze image with AI
    function analyzeImage() {
        const fileInput = document.getElementById("image");
        if (!fileInput.files || !fileInput.files[0]) {
            alert("Proszę najpierw wybrać zdjęcie");
            return;
        }

        const formData = new FormData();
        formData.append("image", fileInput.files[0]);

        // Show loading indicator on button
        const button = event.target.closest("button");
        const indicator = document.getElementById("analyze-indicator");
        const buttonText = document.getElementById("analyze-button-text");

        // Show spinner and disable button
        indicator.style.display = "inline-block";
        button.disabled = true;
        button.classList.add("opacity-75", "cursor-not-allowed");
        if (buttonText) {
            buttonText.textContent = "Analizuję...";
        }

        fetch("/api/analyze-image", {
            method: "POST",
            body: formData,
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                // Hide loading indicator
                indicator.style.display = "none";
                button.disabled = false;
                button.classList.remove("opacity-75", "cursor-not-allowed");
                if (buttonText) {
                    buttonText.textContent = "Opisz zdjęcie za pomocą AI";
                }

                console.log("API Response:", data);

                if (data.error) {
                    showAISuggestion(null, data.error);
                } else {
                    showAISuggestion(data);
                }
            })
            .catch((error) => {
                // Hide loading indicator on error
                indicator.style.display = "none";
                button.disabled = false;
                button.classList.remove("opacity-75", "cursor-not-allowed");
                if (buttonText) {
                    buttonText.textContent = "Opisz zdjęcie za pomocą AI";
                }
                console.error("Fetch Error:", error);
                showAISuggestion(
                    null,
                    "Wystąpił błąd podczas analizy obrazu: " + error.message
                );
            });
    }

    // Show AI suggestion
    function showAISuggestion(data, error = null) {
        const container = document.getElementById("ai-suggestions");

        if (error) {
            container.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p class="text-yellow-800">⚠️ ${error}</p>
                </div>
            `;
            return;
        }

        const escapedTitle = (data.title || "")
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;");
        const escapedDescription = data.description
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;");

        container.innerHTML = `
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-6">
                <div class="flex items-start gap-3 mb-4">
                    <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-purple-900 mb-3">✨ Sugestia AI</h3>
                        <div class="space-y-2 mb-3">
                            <div>
                                <span class="text-sm font-medium text-gray-600">Tytuł:</span>
                                <p class="text-gray-900 font-medium">${data.title}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600">Opis:</span>
                                <p class="text-gray-800 leading-relaxed">${data.description}</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-700">Kategoria:</span>
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full font-medium">${data.category}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="font-medium">Pewność:</span>
                                <span class="capitalize">${data.confidence}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button
                    type="button"
                    onclick="applyAISuggestion('${escapedTitle}', '${escapedDescription}', '${data.category}')"
                    class="w-full mt-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
                >
                    ✓ Użyj tej sugestii
                </button>
            </div>
        `;

        // Scroll to suggestions
        container.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    // Apply AI suggestion to form
    function applyAISuggestion(title, description, category) {
        document.getElementById("title").value = title;
        document.getElementById("description").value = description;
        document.getElementById("category").value = category;

        // Show success message
        const container = document.getElementById("ai-suggestions");
        const originalHTML = container.innerHTML;

        container.innerHTML = `
            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 text-center">
                <p class="text-green-800 font-medium">✓ Sugestia AI została zastosowana!</p>
            </div>
        `;

        // Scroll to title field
        document
            .getElementById("title")
            .scrollIntoView({ behavior: "smooth", block: "center" });

        // Restore original after 2 seconds
        setTimeout(() => {
            container.innerHTML = originalHTML;
        }, 2000);
    }

    // Drag and drop functionality
    const dropZone = document.getElementById("upload-zone");

    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(
            eventName,
            () => {
                dropZone.classList.add("border-blue-500", "bg-blue-50");
            },
            false
        );
    });

    ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(
            eventName,
            () => {
                dropZone.classList.remove("border-blue-500", "bg-blue-50");
            },
            false
        );
    });

    dropZone.addEventListener(
        "drop",
        (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            const fileInput = document.getElementById("image");
            fileInput.files = files;
            handleImageUpload(fileInput);
        },
        false
    );
</script>
{{end}}
